<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dating Sim - Realistic Personality & Memory</title>
  <style>
    body {
      margin: 0; padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #222;
      color: #eee;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      user-select: none;
      overflow-x: hidden;
    }
    #game {
      width: 650px;
      background: #111;
      border-radius: 15px;
      box-shadow: 0 0 20px #d38db1;
      padding: 25px;
      box-sizing: border-box;
      position: relative;
      overflow: hidden;
    }
    #background {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 0;
      filter: brightness(0.7);
      transition: background 1s ease;
    }
    #content {
      position: relative;
      z-index: 1;
    }
    h1 {
      text-align: center;
      margin-top: 0;
      margin-bottom: 15px;
      color: #f48fb1;
      user-select: none;
    }
    #characterSelect {
      text-align: center;
      margin-bottom: 20px;
    }
    #characterSelect button {
      margin: 0 8px;
      padding: 12px 20px;
      border: none;
      border-radius: 12px;
      background: #ba68c8;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s;
      user-select: none;
    }
    #characterSelect button.selected,
    #characterSelect button:hover {
      background: #ec407a;
    }
    #portrait {
      font-size: 90px;
      text-align: center;
      margin-bottom: 10px;
      user-select: none;
    }
    #relationship {
      text-align: center;
      font-weight: bold;
      margin-bottom: 12px;
      user-select: none;
      color: #f48fb1;
    }
    #mood {
      text-align: center;
      font-style: italic;
      margin-bottom: 12px;
      user-select: none;
      color: #fbc02d;
    }
    #dialogue {
      font-size: 18px;
      min-height: 140px;
      margin-bottom: 20px;
      white-space: pre-wrap;
      user-select: text;
      background: rgba(0,0,0,0.3);
      padding: 15px;
      border-radius: 12px;
    }
    #options {
      margin-bottom: 25px;
    }
    .option-btn {
      display: block;
      width: 100%;
      margin: 8px 0;
      padding: 12px;
      font-size: 16px;
      background: #f48fb1;
      border: none;
      border-radius: 12px;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s;
      text-align: left;
      user-select: none;
      position: relative;
    }
    .option-btn:hover:not(:disabled) {
      background: #ec407a;
    }
    .option-btn:disabled {
      background: #555;
      cursor: not-allowed;
      color: #999;
    }
    #timerBarContainer {
      width: 100%;
      background: #333;
      border-radius: 10px;
      height: 10px;
      overflow: hidden;
      margin-bottom: 15px;
      display: none;
    }
    #timerBar {
      height: 100%;
      width: 100%;
      background: #ec407a;
      transition: width 0.2s linear;
    }
    #inventory {
      text-align: center;
      border-top: 1px solid #f48fb1;
      padding-top: 15px;
      user-select: none;
    }
    #inventory strong {
      display: block;
      margin-bottom: 8px;
      color: #f48fb1;
    }
    #inventory button {
      margin: 5px;
      background: #ba68c8;
      border: none;
      border-radius: 10px;
      padding: 8px 14px;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    #inventory button:hover:not(:disabled) {
      background: #ec407a;
    }
    #inventory button:disabled {
      background: #555;
      cursor: not-allowed;
    }
    #customization {
      margin-bottom: 20px;
      text-align: center;
      user-select: none;
    }
    #customization label {
      margin-right: 12px;
      font-weight: bold;
      color: #f48fb1;
    }
    #customization select {
      padding: 6px 10px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      background: #ba68c8;
      color: white;
      cursor: pointer;
    }
    #startGameBtn {
      margin-top: 15px;
      padding: 12px 28px;
      font-size: 18px;
      background: #f48fb1;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      color: white;
      font-weight: bold;
      user-select: none;
    }
    #startGameBtn:hover {
      background: #ec407a;
    }
  </style>
</head>
<body>
  <div id="game">
    <div id="background"></div>
    <div id="content">
      <h1>Dating Sim - Realistic Personality</h1>

      <div id="customization">
        <label for="avatarSelect">Choose your avatar style:</label>
        <select id="avatarSelect">
          <option value="classic">Classic üòä</option>
          <option value="cool">Cool üòé</option>
          <option value="nerdy">Nerdy ü§ì</option>
          <option value="sporty">Sporty üèÉ‚Äç‚ôÇÔ∏è</option>
        </select>
        <br />
        <button id="startGameBtn">Start Game</button>
      </div>

      <div id="characterSelect" style="display:none;">
        <button data-char="lily" class="selected">Talk to Lily</button>
        <button data-char="mia">Talk to Mia</button>
      </div>

      <div id="portrait">üòä</div>
      <div id="relationship"></div>
      <div id="mood"></div>
      <div id="dialogue"></div>
      <div id="timerBarContainer"><div id="timerBar"></div></div>
      <div id="options"></div>

      <div id="inventory" style="display:none;">
        <strong>Inventory:</strong>
        <button id="giveFlower" disabled>Give üåπ Flower</button>
        <button id="giveChocolate" disabled>Give üç´ Chocolate</button>
      </div>
    </div>
  </div>

  <script>
    const backgroundEl = document.getElementById('background');
    const customizationDiv = document.getElementById('customization');
    const avatarSelect = document.getElementById('avatarSelect');
    const startGameBtn = document.getElementById('startGameBtn');

    const characterSelectDiv = document.getElementById('characterSelect');
    const charButtons = characterSelectDiv.querySelectorAll('button');

    const portraitEl = document.getElementById('portrait');
    const relationshipEl = document.getElementById('relationship');
    const moodEl = document.getElementById('mood');
    const dialogueEl = document.getElementById('dialogue');
    const optionsEl = document.getElementById('options');
    const timerBarContainer = document.getElementById('timerBarContainer');
    const timerBar = document.getElementById('timerBar');
    const inventoryDiv = document.getElementById('inventory');
    const giveFlowerBtn = document.getElementById('giveFlower');
    const giveChocolateBtn = document.getElementById('giveChocolate');

    let playerName = "Player";
    let avatarStyle = "classic";

    // Relationship scores for each character
    const relationship = {
      lily: 0,
      mia: 0
    };

    // Mood states per character
    // Calm: 0, Confused:1, Annoyed:2, Angry:3
    const moodStates = ['Calm', 'Confused', 'Annoyed', 'Angry'];
    const moodColors = ['#f48fb1', '#ffd54f', '#ffb300', '#d32f2f'];

    const moods = {
      lily: 0,
      mia: 0
    };

    // Question memory tracker per character: questionId => count
    const questionMemory = {
      lily: {},
      mia: {}
    };

    // Inventory shared for simplicity
    const inventory = {
      flower: 1,
      chocolate: 0
    };

    // Current game state
    let currentCharacter = 'lily';
    let currentNodeKey = '';
    let timerId = null;
    let timerDuration = 0;
    let timerCallback = null;

    // Backgrounds by location
    const backgrounds = {
      park: 'linear-gradient(135deg, #a3d4f7, #64b5f6)', // light blue sky
      cafe: 'linear-gradient(135deg, #f7e1d4, #f5cda7)', // warm beige
      home: 'linear-gradient(135deg, #d4f7e3, #7ae6b8)', // fresh green
      street: 'linear-gradient(135deg, #dadada, #8a8a8a)', // grey urban
    };

    // Expressions by mood (emojis)
    const expressions = {
      lily: {
        0: 'üòä',
        1: 'üòï',
        2: 'üòí',
        3: 'üò†',
        thankYou: 'üôè',
        happy: 'üòÑ',
        sad: 'üò¢'
      },
      mia: {
        0: 'üòÉ',
        1: 'ü§®',
        2: 'üò§',
        3: 'üò°',
        thankYou: 'üôè',
        happy: 'üòÅ',
        sad: 'üòû'
      }
    };

    // Sound effects
    const clickSound = new Audio('https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg');
    clickSound.volume = 0.2;

    // Background music (loop)
    const bgMusic = new Audio('https://cdn.pixabay.com/download/audio/2021/08/04/audio_4344cdb9b4.mp3?filename=relaxing-acoustic-guitar-ambient-9189.mp3');
    bgMusic.volume = 0.15;
    bgMusic.loop = true;

    function playClickSound() {
      clickSound.currentTime = 0;
      clickSound.play();
    }

    // Utility: Typewriter effect
    function typeText(text, callback) {
      dialogueEl.textContent = '';
      let i = 0;
      const speed = 20;
      function type() {
        if (i < text.length) {
          dialogueEl.textContent += text.charAt(i);
          i++;
          setTimeout(type, speed);
        } else {
          callback && callback();
        }
      }
      type();
    }

    // Update UI: portrait, relationship, mood
    function updateUI() {
      const mood = moods[currentCharacter];
      portraitEl.textContent = expressions[currentCharacter][mood] || expressions[currentCharacter][0];
      relationshipEl.textContent = `‚ù§Ô∏è ${capitalize(currentCharacter)}‚Äôs Affection: ${relationship[currentCharacter]}`;
      moodEl.textContent = `Mood: ${moodStates[mood]}`;
      moodEl.style.color = moodColors[mood];
      updateInventoryUI();
      updateBackground();
    }

    function updateBackground() {
      if (!currentNode || !currentNode.location) return;
      const bg = backgrounds[currentNode.location] || backgrounds.park;
      backgroundEl.style.background = bg;
    }

    // Update inventory buttons state
    function updateInventoryUI() {
      giveFlowerBtn.disabled = inventory.flower <= 0;
      giveChocolateBtn.disabled = inventory.chocolate <= 0;
    }

    // Helper capitalize
    function capitalize(s) {
      return s.charAt(0).toUpperCase() + s.slice(1);
    }

    // Clear timer bar and hide
    function clearTimer() {
      if (timerId) clearInterval(timerId);
      timerBarContainer.style.display = 'none';
      timerBar.style.width = '100%';
      timerId = null;
      timerCallback = null;
    }

    // Start timer for timed choices
    function startTimer(seconds, callback) {
      clearTimer();
      timerDuration = seconds;
      timerCallback = callback;
      timerBarContainer.style.display = 'block';
      let elapsed = 0;
      timerBar.style.width = '100%';
      timerId = setInterval(() => {
        elapsed += 0.1;
        const pct = Math.max(0, 1 - elapsed / seconds);
        timerBar.style.width = (pct * 100) + '%';
        if (elapsed >= seconds) {
          clearTimer();
          if (timerCallback) timerCallback();
        }
      }, 100);
    }

    // Give items handlers
    giveFlowerBtn.onclick = () => {
      if (inventory.flower <= 0) return;
      inventory.flower--;
      showNode('giveFlower');
      updateInventoryUI();
    };
    giveChocolateBtn.onclick = () => {
      if (inventory.chocolate <= 0) return;
      inventory.chocolate--;
      showNode('giveChocolate');
      updateInventoryUI();
    };

    // Characters and their stories
    // Added questionId to track repetition and mood effects
    const storyData = {
      lily: {
        start: {
          expression: 0,
          location: 'park',
          text: () => `You see Lily sitting alone on a bench in the park. She looks up and smiles softly.\nWhat do you say, ${playerName}?`,
          options: [
            { text: "Hi, I'm new here. Mind if I sit?", next: "sit", questionId: "sit" },
            { text: "Lovely day, isn't it?", next: "weather", questionId: "weather" },
            { text: "Just passing by.", next: "bye", questionId: "bye" }
          ],
          timed: 0
        },
        sit: {
          expression: 0,
          location: 'park',
          text: (memoryCount) => {
            if(memoryCount > 1) return `"You've already asked that... Are you serious?" Lily frowns.`;
            return `"Of course! I love meeting new people," she says, patting the bench beside her.`;
          },
          options: [
            { text: "So, what brings you here?", next: "meet", questionId: "meet" },
            { text: "Do you come here often?", next: "often", questionId: "often" },
            { text: "I have to go now. Bye!", next: "bye", questionId: "bye" }
          ],
          timed: 10
        },
        weather: {
          expression: 0,
          location: 'park',
          text: (memoryCount) => {
            if(memoryCount > 1) return `"We've already talked about the weather... Honestly, stop it." Lily looks annoyed.`;
            return `"Absolutely! Perfect weather for a stroll," Lily says, her eyes twinkling.`;
          },
          options: [
            { text: "Would you like to join me for a walk?", next: "walk", questionId: "walk" },
            { text: "I should get going, take care!", next: "bye", questionId: "bye" }
          ],
          timed: 12
        },
        meet: {
          expression: 0,
          location: 'park',
          text: (memoryCount) => {
            if(memoryCount > 1) return `"Seriously? You keep asking the same things!" Lily's face tightens.`;
            return `"I'm just enjoying some quiet time after a hectic week," she replies.`;
          },
          options: [
            { text: "I understand. Want to grab a coffee later?", next: "coffee", questionId: "coffee" },
            { text: "Maybe some other time. See you around!", next: "bye", questionId: "bye" }
          ],
          timed: 10
        },
        often: {
          expression: 0,
          location: 'park',
          text: (memoryCount) => {
            if(memoryCount > 1) return `"Stop repeating yourself! It's rude." Lily crosses her arms.`;
            return `"Yeah, I like to come here when I want to relax and think."`;
          },
          options: [
            { text: "What's your favorite thing here?", next: "favorite", questionId: "favorite" },
            { text: "Got to run, bye!", next: "bye", questionId: "bye" }
          ],
          timed: 10
        },
        favorite: {
          expression: 0,
          location: 'park',
          text: `"I love the cherry blossom trees. They remind me of childhood memories."`,
          options: [
            { text: "Sounds lovely!", next: "end_good", questionId: "end_good" },
            { text: "I have to go now.", next: "bye", questionId: "bye" }
          ],
          timed: 0
        },
        walk: {
          expression: 0,
          location: 'street',
          text: `"I'd love that. Let's enjoy the day together."`,
          options: [
            { text: "Lead the way.", next: "end_good", questionId: "end_good" },
            { text: "Actually, I have to go.", next: "bye", questionId: "bye" }
          ],
          timed: 15
        },
        coffee: {
          expression: 0,
          location: 'cafe',
          text: `"Coffee sounds great. See you later!"`,
          options: [
            { text: "Looking forward to it!", next: "end_good", questionId: "end_good" }
          ],
          timed: 0
        },
        bye: {
          expression: 3,
          location: 'park',
          text: `"Alright, take care."`,
          options: [
            { text: "Restart", next: "start", questionId: "start" }
          ],
          timed: 0
        },
        end_good: {
          expression: 0,
          location: 'park',
          text: `You spend a lovely day with Lily and feel a true connection. üíñ`,
          options: [
            { text: "Play again", next: "start" }
          ],
          timed: 0
        },
        giveFlower: {
          expression: 'thankYou',
          location: 'park',
          text: `"Oh, a flower? That's so sweet! Thank you, ${playerName}!"`,
          options: [
            { text: "You're welcome!", next: "start" }
          ],
          effect: () => {
            relationship.lily += 2;
            moods.lily = Math.max(0, moods.lily - 1); // calm her a bit
          },
          timed: 0
        },
        giveChocolate: {
          expression: 'happy',
          location: 'park',
          text: `"Chocolate! You really know how to make me smile!"`,
          options: [
            { text: "Glad you like it!", next: "start" }
          ],
          effect: () => {
            relationship.lily += 3;
            moods.lily = Math.max(0, moods.lily - 2);
          },
          timed: 0
        }
      },

      mia: {
        start: {
          expression: 0,
          location: 'cafe',
          text: () => `Mia is reading a book in a cozy corner of the cafe. She looks up when you approach.\nWhat do you say, ${playerName}?`,
          options: [
            { text: "Hey Mia, what are you reading?", next: "book", questionId: "book" },
            { text: "Want to grab some coffee?", next: "coffee", questionId: "coffee" },
            { text: "Just saying hi.", next: "hi", questionId: "hi" }
          ],
          timed: 0
        },
        book: {
          expression: 0,
          location: 'cafe',
          text: (memoryCount) => {
            if(memoryCount > 1) return `"You asked that before... Please stop." Mia sighs.`;
            return `"It's a mystery novel. I love a good puzzle," Mia says with a smile.`;
          },
          options: [
            { text: "Do you like puzzles?", next: "puzzles", questionId: "puzzles" },
            { text: "Maybe we can solve one together sometime.", next: "together", questionId: "together" }
          ],
          timed: 10
        },
        coffee: {
          expression: 0,
          location: 'cafe',
          text: `"I'd love to! Let's go!"`,
          options: [
            { text: "Lead the way.", next: "walk", questionId: "walk" },
            { text: "Actually, I have to run.", next: "bye", questionId: "bye" }
          ],
          timed: 15
        },
        hi: {
          expression: 0,
          location: 'cafe',
          text: `"Hi! Nice to see you around."`,
          options: [
            { text: "Same here!", next: "start", questionId: "start" }
          ],
          timed: 0
        },
        puzzles: {
          expression: 0,
          location: 'cafe',
          text: `"Yes! Puzzles are my favorite way to relax."`,
          options: [
            { text: "Let's solve one now.", next: "puzzleMiniGame", questionId: "puzzleMiniGame" },
            { text: "Maybe later.", next: "start", questionId: "start" }
          ],
          timed: 12
        },
        together: {
          expression: 0,
          location: 'street',
          text: `You plan to meet Mia for a puzzle-solving day.`,
          options: [
            { text: "Can't wait!", next: "end_good", questionId: "end_good" }
          ],
          timed: 0
        },
        walk: {
          expression: 0,
          location: 'street',
          text: `You and Mia walk down a lively street, chatting happily.`,
          options: [
            { text: "Ask about her favorite mystery book.", next: "book", questionId: "book" },
            { text: "Enjoy the scenery.", next: "start", questionId: "start" }
          ],
          timed: 10
        },
        bye: {
          expression: 3,
          location: 'cafe',
          text: `"Catch you later!" Mia waves goodbye.`,
          options: [
            { text: "Restart", next: "start", questionId: "start" }
          ],
          timed: 0
        },
        end_good: {
          expression: 0,
          location: 'home',
          text: "You and Mia become good friends and share many puzzle adventures! üéâ",
          options: [
            { text: "Play again", next: "start" }
          ],
          timed: 0
        },
        puzzleMiniGame: {
          expression: 1,
          location: 'cafe',
          text: `Mini-game: Solve this riddle:\nI speak without a mouth and hear without ears. I have nobody, but I come alive with wind. What am I?`,
          options: [
            { text: "An echo", next: "puzzleWin", questionId: "puzzleWin" },
            { text: "A shadow", next: "puzzleLose", questionId: "puzzleLose" },
            { text: "A whisper", next: "puzzleLose", questionId: "puzzleLose" }
          ],
          timed: 20
        },
        puzzleWin: {
          expression: 0,
          location: 'cafe',
          text: `"Correct! You're quite clever."`,
          options: [
            { text: "Thanks!", next: "start", questionId: "start" }
          ],
          effect: () => {
            relationship.mia += 5;
            moods.mia = Math.max(0, moods.mia - 1);
          },
          timed: 0
        },
        puzzleLose: {
          expression: 3,
          location: 'cafe',
          text: `"Not quite, but that's okay!"`,
          options: [
            { text: "I'll try harder next time.", next: "start", questionId: "start" }
          ],
          timed: 0
        },
        giveFlower: {
          expression: 'thankYou',
          location: 'cafe',
          text: `"A flower? That's so thoughtful! Thanks, ${playerName}!"`,
          options: [
            { text: "You're welcome!", next: "start" }
          ],
          effect: () => {
            relationship.mia += 2;
            moods.mia = Math.max(0, moods.mia - 1);
          },
          timed: 0
        },
        giveChocolate: {
          expression: 'happy',
          location: 'cafe',
          text: `"Chocolate? Yum! Thanks!"`,
          options: [
            { text: "Glad you like it!", next: "start" }
          ],
          effect: () => {
            relationship.mia += 3;
            moods.mia = Math.max(0, moods.mia - 2);
          },
          timed: 0
        }
      }
    };

    let currentNode = null;

    // Show node - handle repeated questions & mood change
    function showNode(key) {
      if (!currentCharacter) return;
      const charStory = storyData[currentCharacter];
      if (!charStory) return;
      let node = charStory[key];
      if (!node) return;

      // Track question repetition if questionId exists
      if (node.questionId) {
        questionMemory[currentCharacter][node.questionId] = (questionMemory[currentCharacter][node.questionId] || 0) + 1;
      }

      // Prepare text with memoryCount for repeated questions
      let memoryCount = node.questionId ? questionMemory[currentCharacter][node.questionId] : 0;

      // Update mood if repeated question asked multiple times
      if (memoryCount > 1) {
        moods[currentCharacter] = Math.min(3, moods[currentCharacter] + 1);
      } else {
        // If question new or only once, mood gradually calms down
        moods[currentCharacter] = Math.max(0, moods[currentCharacter] - 0.1);
      }

      // If node.text is function, call with memoryCount
      let displayText = typeof node.text === 'function' ? node.text(memoryCount) : node.text;

      // Apply mood-based expression fallback for numbers
      let expression = node.expression;
      if (typeof expression === 'number') {
        expression = moods[currentCharacter];
      }
      // Map expression strings
      if (typeof expression === 'string' && expressions[currentCharacter][expression]) {
        expression = expressions[currentCharacter][expression];
      }

      currentNode = {...node, text: displayText, expression};
      currentNodeKey = key;

      updateUI();
      clearTimer();

      // Run any effect tied to node
      if (node.effect) node.effect();

      // Animate text with typewriter effect, then render options
      typeText(displayText, () => {
        renderOptions(node.options);
        if (node.timed && node.timed > 0) {
          startTimer(node.timed, () => {
            if (node.options && node.options.length > 0) {
              showNode(node.options[0].next);
            } else {
              showNode('start');
            }
          });
        }
      });
    }

    // Render choice buttons
    function renderOptions(options) {
      optionsEl.innerHTML = '';
      if (!options || options.length === 0) return;
      options.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.textContent = opt.text;
        btn.onclick = () => {
          playClickSound();
          showNode(opt.next);
        };
        optionsEl.appendChild(btn);
      });
    }

    // Switch character to talk to
    function switchCharacter(char) {
      currentCharacter = char;
      charButtons.forEach(b => b.classList.remove('selected'));
      const btn = Array.from(charButtons).find(b => b.dataset.char === char);
      if (btn) btn.classList.add('selected');
      showNode('start');
    }

    // Start game button event
    startGameBtn.onclick = () => {
      avatarStyle = avatarSelect.value;
      customizationDiv.style.display = 'none';
      characterSelectDiv.style.display = 'block';
      inventoryDiv.style.display = 'block';
      switchCharacter('lily');
      bgMusic.play();
    };

    // Character buttons events
    charButtons.forEach(btn => {
      btn.onclick = () => {
        playClickSound();
        switchCharacter(btn.dataset.char);
      };
    });

    // Initial update UI before start
    updateUI();

  </script>
</body>
</html>
