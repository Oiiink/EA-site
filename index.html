<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>🌼 Grow a Garden</title>
<style>
  /* Reset & base */
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0; padding: 0;
    background: linear-gradient(to bottom, #e6ffe6, #ccffcc);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #2c3e50;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }
  header {
    background: #4caf50;
    color: white;
    padding: 12px 20px;
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    font-size: 18px;
    gap: 10px;
  }
  #seasonWeather {
    font-weight: 700;
    min-width: 180px;
  }
  #timers {
    font-size: 14px;
    min-width: 200px;
  }
  main {
    flex-grow: 1;
    max-width: 1000px;
    margin: 20px auto;
    padding: 0 10px;
    width: 100%;
  }
  #farm {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    gap: 12px;
    justify-content: center;
  }
  .plot {
    width: 80px;
    height: 80px;
    background-color: #a0522d;
    border: 3px solid #654321;
    border-radius: 12px;
    position: relative;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    user-select: none;
    transition: border-color 0.3s ease;
    box-shadow: inset 0 0 6px #4caf50;
  }
  .plot:hover {
    border-color: #3e8e41;
    box-shadow: 0 0 10px #66bb6a;
  }
  .growTimer {
    position: absolute;
    bottom: 6px;
    width: 100%;
    font-size: 12px;
    color: #fff;
    text-shadow: 1px 1px 3px #000;
    font-weight: 700;
    user-select: none;
  }
  .rarityCommon { color: #555; }
  .rarityUncommon { color: #1e90ff; }
  .rarityRare { color: #4caf50; }
  .rarityEpic { color: #9c27b0; }
  .rarityLegendary { color: #ff9800; font-weight: 700; }

  #controls {
    margin: 15px 0 25px 0;
    display: flex;
    justify-content: center;
    gap: 18px;
    flex-wrap: wrap;
  }
  button {
    background-color: #66bb6a;
    border: none;
    border-radius: 8px;
    padding: 12px 20px;
    color: white;
    font-weight: 700;
    font-size: 16px;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(50, 168, 82, 0.6);
    transition: background-color 0.3s ease, transform 0.15s ease;
  }
  button:hover:not(:disabled) {
    background-color: #4caf50;
    transform: scale(1.05);
  }
  button:disabled {
    background-color: #9e9e9e;
    cursor: not-allowed;
    box-shadow: none;
    transform: none;
  }

  #inventory {
    display: flex;
    justify-content: center;
    gap: 25px;
    font-weight: 700;
    font-size: 18px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  #inventory > div {
    background: #d4f1d4;
    padding: 10px 20px;
    border-radius: 12px;
    box-shadow: inset 0 0 6px #88cc88;
    user-select: none;
    min-width: 110px;
    text-align: center;
  }

  #market, #encyclopedia {
    margin: 0 auto 40px auto;
    max-width: 1000px;
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
  }
  #market {
    flex: 2;
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 0 12px #a4d6a4;
  }
  #market h2 {
    margin-top: 0;
    border-bottom: 3px solid #4caf50;
    padding-bottom: 8px;
  }
  #marketTimer {
    font-size: 14px;
    margin-bottom: 12px;
    font-weight: 700;
    color: #388e3c;
  }
  #marketGrid {
    display: flex;
    flex-wrap: wrap;
    gap: 18px;
    justify-content: center;
  }
  .marketItem {
    background: #f9fff9;
    border: 2px solid #4caf50;
    border-radius: 10px;
    padding: 14px;
    width: 140px;
    cursor: pointer;
    position: relative;
    box-shadow: 0 2px 5px rgba(76, 175, 80, 0.4);
    transition: background-color 0.3s ease, transform 0.2s ease;
  }
  .marketItem:hover {
    background-color: #d1f0d1;
    transform: scale(1.07);
  }
  .marketIcon {
    font-size: 38px;
    margin-bottom: 8px;
    user-select: none;
  }
  .marketName {
    font-weight: 700;
    font-size: 17px;
    margin-bottom: 6px;
  }
  .marketPrice {
    font-weight: 700;
    color: #2e7d32;
    font-size: 15px;
  }
  .tooltip {
    position: absolute;
    top: -4px;
    left: 100%;
    background: #333;
    color: white;
    padding: 6px 10px;
    border-radius: 8px;
    font-size: 13px;
    white-space: nowrap;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 10;
  }
  .marketItem:hover .tooltip {
    opacity: 1;
  }

  #encyclopedia {
    flex: 1;
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 0 12px #a4d6a4;
    display: flex;
    flex-direction: column;
    max-height: 540px;
    min-width: 270px;
  }
  #encyclopedia h2 {
    margin-top: 0;
    border-bottom: 3px solid #4caf50;
    padding-bottom: 8px;
  }
  #encyclopediaSort {
    margin-bottom: 14px;
    padding: 6px 8px;
    font-size: 16px;
    border-radius: 8px;
    border: 2px solid #4caf50;
    font-weight: 700;
    cursor: pointer;
  }
  #cropList {
    overflow-y: auto;
    flex-grow: 1;
    font-size: 14px;
    border-top: 1px solid #ddd;
    padding-top: 8px;
  }
  .encyclopediaEntry {
    padding: 8px 10px;
    border-bottom: 1px solid #ddd;
    cursor: default;
    user-select: none;
  }
</style>
</head>
<body>
<header>
  <div id="seasonWeather">Season: <span id="season">Spring</span> | Weather: <span id="weather">Sunny</span></div>
  <div id="timers">
    Market restock in: <span id="marketTimer">05:00</span> |
    Next event in: <span id="eventTimer">02:00</span>
  </div>
</header>

<main>
  <div id="farm" aria-label="Farm plots"></div>

  <div id="controls" role="region" aria-label="Game Controls">
    <button id="buySeedBtn" title="Buy a random seed from the market">Buy Seed 🌱</button>
    <button id="buyFertilizerBtn" title="Buy fertilizer to boost mutation and growth speed">Buy Fertilizer 🌿</button>
  </div>

  <div id="inventory" role="region" aria-label="Inventory and resources">
    <div>Gold: <span id="gold">100</span></div>
    <div>Seeds: <span id="seedCount">0</span></div>
    <div>Fertilizer: <span id="fertilizerCount">0</span></div>
  </div>

  <section id="market" aria-label="Market">
    <h2>🛒 Market</h2>
    <div id="marketTimer"></div>
    <div id="marketGrid" role="list"></div>
  </section>

  <section id="encyclopedia" aria-label="Crop Encyclopedia">
    <h2>📚 Crop Encyclopedia</h2>
    <label for="encyclopediaSort">Sort by: </label>
    <select id="encyclopediaSort" aria-controls="cropList" aria-label="Sort encyclopedia entries">
      <option value="name">Name</option>
      <option value="rarity">Rarity</option>
      <option value="value">Sell Value</option>
    </select>
    <div id="cropList" role="list"></div>
  </section>
</main>

<script>
(() => {
  // Data
  const cropsData = [
    { name: "Carrot", icon: "🥕", baseSellPrice: 10, growTime: 20000 },
    { name: "Strawberry", icon: "🍓", baseSellPrice: 15, growTime: 30000 },
    { name: "Corn", icon: "🌽", baseSellPrice: 20, growTime: 35000 },
    { name: "Pumpkin", icon: "🎃", baseSellPrice: 30, growTime: 45000 }
  ];

  const rarities = [
    { label: "Common", color: "#555", mutationBoost: 0, chance: 0.6, className: "rarityCommon" },
    { label: "Uncommon", color: "#1e90ff", mutationBoost: 0.05, chance: 0.25, className: "rarityUncommon" },
    { label: "Rare", color: "#4caf50", mutationBoost: 0.1, chance: 0.1, className: "rarityRare" },
    { label: "Epic", color: "#9c27b0", mutationBoost: 0.15, chance: 0.04, className: "rarityEpic" },
    { label: "Legendary", color: "#ff9800", mutationBoost: 0.25, chance: 0.01, className: "rarityLegendary" }
  ];

  const seasons = ["Spring", "Summer", "Fall", "Winter"];
  const seasonEffects = {
    Spring: { mutationBoost: 0.10, growSpeedMultiplier: 1, sellPriceMultiplier: 1 },
    Summer: { mutationBoost: 0, growSpeedMultiplier: 0.8, sellPriceMultiplier: 1 },
    Fall: { mutationBoost: 0, growSpeedMultiplier: 1, sellPriceMultiplier: 1.2 },
    Winter: { mutationBoost: -0.1, growSpeedMultiplier: 1.2, sellPriceMultiplier: 1 }
  };

  const weatherTypes = [
    { name: "Sunny", growSpeedMultiplier: 1, autoWaterChance: 0 },
    { name: "Rain", growSpeedMultiplier: 1.2, autoWaterChance: 0 },
    { name: "Storm", growSpeedMultiplier: 1, autoWaterChance: 0.1 },
    { name: "Snow", growSpeedMultiplier: 1.3, autoWaterChance: 0 }
  ];

  const pets = [
    { name: "Butterfly", mutationBoost: 0.1 }
  ];

  const maxPlots = 20;
  let farmPlots = [];
  let gold = 100;
  let seedsInventory = {};
  let fertilizerCount = 0;
  let currentSeasonIndex = 0;
  let currentWeatherIndex = 0;
  let marketStock = [];
  let marketRestockTimer = 300; // seconds
  let eventTimer = 120; // seconds
  let encyclopedia = {};
  let selectedSort = "name";

  const farmEl = document.getElementById("farm");
  const goldEl = document.getElementById("gold");
  const seedCountEl = document.getElementById("seedCount");
  const fertilizerEl = document.getElementById("fertilizerCount");
  const buySeedBtn = document.getElementById("buySeedBtn");
  const buyFertilizerBtn = document.getElementById("buyFertilizerBtn");
  const marketGrid = document.getElementById("marketGrid");
  const marketTimerEl = document.getElementById("marketTimer");
  const eventTimerEl = document.getElementById("eventTimer");
  const seasonEl = document.getElementById("season");
  const weatherEl = document.getElementById("weather");
  const cropListEl = document.getElementById("cropList");
  const encyclopediaSort = document.getElementById("encyclopediaSort");

  // Utility Functions
  function formatTime(seconds) {
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    return `${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
  }

  function weightedRandom(items, weightProp) {
    let totalWeight = items.reduce((sum, item) => sum + item[weightProp], 0);
    let rand = Math.random() * totalWeight;
    for (let item of items) {
      if (rand < item[weightProp]) return item;
      rand -= item[weightProp];
    }
    return items[items.length - 1];
  }

  // Initialize farm plots
  function initFarm() {
    farmEl.innerHTML = "";
    farmPlots = [];
    for (let i = 0; i < maxPlots; i++) {
      const div = document.createElement("div");
      div.className = "plot";
      div.title = "Empty plot. Click to plant.";
      div.setAttribute("role", "button");
      div.setAttribute("tabindex", "0");
      div.addEventListener("click", () => onPlotClick(i));
      div.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          onPlotClick(i);
          e.preventDefault();
        }
      });
      farmEl.appendChild(div);
      farmPlots.push({
        element: div,
        planted: false,
        crop: null,
        rarity: null,
        growthStart: null,
        growTime: null,
        growTimerId: null,
        mutated: false,
      });
    }
  }

  // Update UI elements (gold, seeds, fertilizer counts)
  function updateInventoryUI() {
    goldEl.textContent = gold;
    let totalSeeds = Object.values(seedsInventory).reduce((a,b) => a+b, 0);
    seedCountEl.textContent = totalSeeds;
    fertilizerEl.textContent = fertilizerCount;
    buySeedBtn.disabled = totalSeeds >= 10;
    buyFertilizerBtn.disabled = gold < 25;
  }

  // Update season and weather UI
  function updateSeasonWeatherUI() {
    seasonEl.textContent = seasons[currentSeasonIndex];
    weatherEl.textContent = weatherTypes[currentWeatherIndex].name;
  }

  // Change season every 2 minutes
  function cycleSeason() {
    currentSeasonIndex = (currentSeasonIndex + 1) % seasons.length;
    updateSeasonWeatherUI();
  }

  // Change weather every 90 seconds
  function cycleWeather() {
    currentWeatherIndex = (currentWeatherIndex + 1) % weatherTypes.length;
    updateSeasonWeatherUI();
  }

  // Calculate mutation chance influenced by rarity, season, pets, fertilizer
  function calculateMutationChance(baseChance, rarity, seasonBoost, hasFertilizer, pets) {
    let chance = baseChance;
    chance += rarity.mutationBoost;
    chance += seasonBoost;
    if (hasFertilizer) chance += 0.15;
    pets.forEach(p => {
      chance += p.mutationBoost;
    });
    return Math.min(1, chance);
  }

  // Plant a crop if player has seeds
  function plantCrop(plotIndex, cropName = null) {
    const plot = farmPlots[plotIndex];
    if (plot.planted) return alert("Plot already planted!");
    if (!cropName) {
      // Pick any crop with seeds available
      const availableCrops = Object.entries(seedsInventory).filter(([c,n]) => n > 0);
      if (availableCrops.length === 0) return alert("No seeds available to plant!");
      cropName = availableCrops[0][0];
    }
    if (!seedsInventory[cropName] || seedsInventory[cropName] <= 0) {
      alert(`No seeds for ${cropName} available.`);
      return;
    }
    // Determine rarity with mutation chance
    const baseRarity = weightedRandom(rarities, "chance");
    const seasonBoost = seasonEffects[seasons[currentSeasonIndex]].mutationBoost;
    const mutationChance = calculateMutationChance(0.1, baseRarity, seasonBoost, fertilizerCount > 0, pets);
    let finalRarity = baseRarity;
    if (Math.random() < mutationChance) {
      // Upgrade rarity if possible
      let newIndex = rarities.indexOf(baseRarity) + 1;
      if (newIndex >= rarities.length) newIndex = rarities.length - 1;
      finalRarity = rarities[newIndex];
    }

    plot.planted = true;
    plot.crop = cropsData.find(c => c.name === cropName);
    plot.rarity = finalRarity;
    plot.growthStart = Date.now();
    plot.growTime = plot.crop.growTime / seasonEffects[seasons[currentSeasonIndex]].growSpeedMultiplier;
    if (fertilizerCount > 0) {
      plot.growTime *= 0.85;
      fertilizerCount--;
      alert("Fertilizer used! Growth speed increased.");
    }
    plot.mutated = finalRarity !== baseRarity;

    seedsInventory[cropName]--;
    if (seedsInventory[cropName] <= 0) delete seedsInventory[cropName];

    // Visual update
    plot.element.innerHTML = `<div style="font-size: 32px;">${plot.crop.icon}</div>
      <div class="growTimer ${finalRarity.className}">${finalRarity.label} - 0s</div>`;
    plot.element.style.borderColor = finalRarity.color;

    // Start growth timer
    if (plot.growTimerId) clearInterval(plot.growTimerId);
    plot.growTimerId = setInterval(() => {
      const elapsed = Date.now() - plot.growthStart;
      const timeLeft = Math.max(0, Math.ceil((plot.growTime - elapsed) / 1000));
      const timerDiv = plot.element.querySelector(".growTimer");
      if (timerDiv) timerDiv.textContent = `${finalRarity.label} - ${timeLeft}s`;
      if (timeLeft <= 0) {
        clearInterval(plot.growTimerId);
        plot.growTimerId = null;
        timerDiv.textContent = `${finalRarity.label} - Ready!`;
        plot.element.title = "Click to harvest!";
      }
    }, 1000);

    updateInventoryUI();
    addToEncyclopedia(plot.crop.name, finalRarity.label, plot.crop.baseSellPrice);
  }

  // Harvest a plot if ready
  function harvestCrop(plotIndex) {
    const plot = farmPlots[plotIndex];
    if (!plot.planted) return alert("Plot is empty. Plant seeds first.");
    const elapsed = Date.now() - plot.growthStart;
    if (elapsed < plot.growTime) return alert("Crop not ready yet!");

    // Calculate sell price with rarity and season effects
    let price = plot.crop.baseSellPrice * (1 + rarities.indexOf(plot.rarity) * 0.2);
    price *= seasonEffects[seasons[currentSeasonIndex]].sellPriceMultiplier;
    price = Math.round(price);

    gold += price;
    alert(`Harvested ${plot.crop.name} (${plot.rarity.label}) for ${price} gold!`);

    plot.planted = false;
    plot.crop = null;
    plot.rarity = null;
    plot.growthStart = null;
    plot.growTime = null;
    plot.mutated = false;
    plot.element.innerHTML = "";
    plot.element.style.borderColor = "#654321";
    plot.element.title = "Empty plot. Click to plant.";

    updateInventoryUI();
  }

  // Handle plot click (plant or harvest)
  function onPlotClick(i) {
    const plot = farmPlots[i];
    if (!plot.planted) {
      plantCrop(i);
    } else {
      harvestCrop(i);
    }
  }

  // Encyclopedia management
  function addToEncyclopedia(name, rarityLabel, basePrice) {
    const key = name + rarityLabel;
    if (!encyclopedia[key]) {
      encyclopedia[key] = { name, rarityLabel, basePrice };
      renderEncyclopedia();
    }
  }

  function renderEncyclopedia() {
    let entries = Object.values(encyclopedia);
    if (selectedSort === "name") {
      entries.sort((a,b) => a.name.localeCompare(b.name));
    } else if (selectedSort === "rarity") {
      entries.sort((a,b) => rarities.findIndex(r => r.label === b.rarityLabel) - rarities.findIndex(r => r.label === a.rarityLabel));
    } else if (selectedSort === "value") {
      entries.sort((a,b) => b.basePrice - a.basePrice);
    }
    cropListEl.innerHTML = "";
    for (const entry of entries) {
      const rarityObj = rarities.find(r => r.label === entry.rarityLabel);
      const div = document.createElement("div");
      div.className = `encyclopediaEntry ${rarityObj.className}`;
      div.textContent = `${entry.name} — Rarity: ${entry.rarityLabel} — Base Sell: ${entry.basePrice}g`;
      cropListEl.appendChild(div);
    }
  }

  // Market functions
  function restockMarket() {
    marketStock = [];
    const available = [...cropsData];
    for (let i = 0; i < 5; i++) {
      if (available.length === 0) break;
      const idx = Math.floor(Math.random() * available.length);
      const crop = available.splice(idx, 1)[0];
      const price = Math.floor(crop.baseSellPrice * (0.6 + Math.random() * 0.4));
      marketStock.push({...crop, price});
    }
    // Add fertilizer and watering cans
    marketStock.push({name: "Fertilizer", icon: "🌿", price: 25, type: "fertilizer", description: "Boost mutation chance and growth speed"});
    marketStock.push({name: "Watering Can", icon: "💧", price: 15, type: "watering", description: "Chance to auto-water crops each tick"});
  }

  function renderMarket() {
    marketGrid.innerHTML = "";
    marketStock.forEach(item => {
      const div = document.createElement("div");
      div.className = "marketItem";
      div.title = item.description || "";
      div.innerHTML = `<div class="marketIcon">${item.icon}</div>
                       <div class="marketName">${item.name}</div>
                       <div class="marketPrice">${item.price}g</div>
                       <div class="tooltip">${item.description || ""}</div>`;
      div.addEventListener("click", () => buyMarketItem(item));
      marketGrid.appendChild(div);
    });
  }

  function buyMarketItem(item) {
    if (gold < item.price) return alert("Not enough gold.");
    gold -= item.price;
    if (item.type === "fertilizer") {
      fertilizerCount++;
      alert("Bought fertilizer! It boosts mutation chance and growth speed.");
    } else if (item.type === "watering") {
      alert("Bought watering can! It gives a chance to auto-water crops.");
      // Could implement watering can effects here
    } else {
      seedsInventory[item.name] = (seedsInventory[item.name] || 0) + 1;
      alert(`Bought 1 ${item.name} seed.`);
    }
    updateInventoryUI();
  }

  // Timers and events
  function tickTimers() {
    marketRestockTimer--;
    eventTimer--;

    if (marketRestockTimer <= 0) {
      restockMarket();
      renderMarket();
      marketRestockTimer = 300;
    }
    if (eventTimer <= 0) {
      triggerRandomEvent();
      eventTimer = 120;
    }

    marketTimerEl.textContent = formatTime(marketRestockTimer);
    eventTimerEl.textContent = formatTime(eventTimer);
  }

  function triggerRandomEvent() {
    const eventTypes = ["pest", "rain", "drought"];
    const event = eventTypes[Math.floor(Math.random() * eventTypes.length)];
    switch(event) {
      case "pest":
        alert("🐛 Pests have appeared! They slow crop growth temporarily.");
        // Slow all growing crops for 30s
        farmPlots.forEach(plot => {
          if (plot.planted && plot.growTimerId) {
            clearInterval(plot.growTimerId);
            let elapsed = Date.now() - plot.growthStart;
            plot.growthStart += 15000; // delay growth by 15s (half event duration)
            startGrowthTimer(farmPlots.indexOf(plot));
          }
        });
        break;
      case "rain":
        alert("🌧️ It’s raining! Crops grow faster for a short time.");
        // Could boost growSpeedMultiplier temporarily
        break;
      case "drought":
        alert("☀️ Drought hits! Crops grow slower for a short time.");
        // Could slow growSpeedMultiplier temporarily
        break;
    }
  }

  // Button handlers
  buySeedBtn.addEventListener("click", () => {
    // Buy a random seed from market if available
    const seedItems = marketStock.filter(item => !item.type);
    if (seedItems.length === 0) {
      alert("No seeds available in market right now.");
      return;
    }
    const item = seedItems[Math.floor(Math.random() * seedItems.length)];
    buyMarketItem(item);
  });

  buyFertilizerBtn.addEventListener("click", () => {
    const fertItem = marketStock.find(i => i.type === "fertilizer");
    if (!fertItem) return alert("No fertilizer available right now.");
    buyMarketItem(fertItem);
  });

  encyclopediaSort.addEventListener("change", (e) => {
    selectedSort = e.target.value;
    renderEncyclopedia();
  });

  // Start growth timer helper (used on pests event)
  function startGrowthTimer(plotIndex) {
    const plot = farmPlots[plotIndex];
    if (!plot.planted) return;
    if (plot.growTimerId) clearInterval(plot.growTimerId);
    plot.growTimerId = setInterval(() => {
      const elapsed = Date.now() - plot.growthStart;
      const timeLeft = Math.max(0, Math.ceil((plot.growTime - elapsed) / 1000));
      const timerDiv = plot.element.querySelector(".growTimer");
      if (timerDiv) timerDiv.textContent = `${plot.rarity.label} - ${timeLeft}s`;
      if (timeLeft <= 0) {
        clearInterval(plot.growTimerId);
        plot.growTimerId = null;
        timerDiv.textContent = `${plot.rarity.label} - Ready!`;
        plot.element.title = "Click to harvest!";
      }
    }, 1000);
  }

  // Initialize game
  function init() {
    initFarm();
    restockMarket();
    renderMarket();
    updateInventoryUI();
    updateSeasonWeatherUI();
    renderEncyclopedia();
    setInterval(tickTimers, 1000);
    setInterval(cycleSeason, 120000);
    setInterval(cycleWeather, 90000);
  }

  init();
})();
</script>
</body>
</html>
